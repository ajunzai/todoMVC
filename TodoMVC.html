<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="./css/index.css">
    <script type="text/javascript" src="./lib/vue.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
    <section class="todoapp">
        <header class="header">
            <h1>任务清单</h1>
            <input @keyup.enter="addToDo" v-model="inputToDo" autofocus="autofocus" autocomplete="off" placeholder="想干啥?" class="new-todo">
        </header>
        <section class="main">
            <input v-model="checkAll" @change="checkAllToDo" type="checkbox" class="toggle-all">
            <ul class="todo-list" v-cloak>
                <!-- 循环列表 给ul增加在页面刷新情况下不显示胡子语法  -->
                <li class="todo" :class="{completed:item.complete,editing:item.isEdit}" v-for="(item, index) in visiableList" :key="item.name">
                    <div class="view">
                        <input @change="checkIscheckAll" type="checkbox" v-model="item.complete" class="toggle">
                        <label @dblclick="editToDo(index)">{{item.name}}</label>
                        <button @click="deleteEdit(index)" class="destroy"></button>
                    </div>
                    <input v-if="item.isEdit" v-focus v-model="cacheEdit" @keyup.esc="cancelEdit(index)" @blur="beforeEdit(index)" @keyup.enter="saveEdit(index)" type="text"
                        class="edit">
                </li>
            </ul>
        </section>
        <footer class="footer">
            <span v-if="visibility!='完成'" class="todo-count" v-show="doDoneNum!=0">
                <strong>{{doDoneNum.NoDone}}</strong> 项 剩余
            </span>
            <span v-if="visibility=='完成'" class="todo-count" v-show="doDoneNum!=0">
                    <strong>{{doDoneNum.Done}}</strong> 项 完成
                </span>
            <ul class="filters">
                <li>
                    <a href="#/all" :class="{selected:visibility=='全部'}" @click="ligthHigh('全部')">全部</a>
                </li>
                <li>
                    <a href="#/active" :class="{selected:visibility=='未完成'}" @click="ligthHigh('未完成')">未完成</a>
                </li>
                <li>
                    <a href="#/completed" :class="{selected:visibility=='完成'}" @click="ligthHigh('完成')">完成</a>
                </li>
            </ul>
            <button @click="clear" class="clear-completed">
                清空列表
            </button>
        </footer>
    </section>
    <footer class="info">
        <p>双击进入编辑状态</p>
        <p>鸣谢:
            <a href="http://evanyou.me">Evan You</a>
        </p>
        <p>参考于
            <a href="http://todomvc.com">TodoMVC</a>
        </p>
    </footer>
</body>
<!-- 
    分析
        1.数据结构
            页面中的todo列表保存的数据渲染
        2.判断是否选中input 
            数据进行双向绑定
        3.给新增加入回车事件
            获取输入的内容 按回车保存在列表中 清空输入框
            输入框为空 按回车无效果
        4.双击进入编辑状态   
            双向绑定li里面的状态  
            数据绑定到cacheEdit中
        5.自动获取焦点 (插入自定义组件)
        6.失去焦点回到开始状态
        7.esc退出编辑状态
        8.情空所有事件
        9.删除单个列表
        10.计算未完成的数量
        11.做筛选高亮
            点击谁 谁高亮 那么以一个变量{"完成","未完成","全部"}来判定  进行双向绑定
        12.筛选显示的值 因为每次循环的数组不一样 需要计算返回一个新数组
        13.全选高亮  下方跟着全选的prop值  定义变量 数据双向绑定
        14.判断总个数与选中的个数相同 记全选高亮 反之 (在checkbox中用change事件可以实时监控value值的变化)
            给每个按钮点击事件
        15.数据常驻
            用localstorage保存数据
            浏览器关闭情况下保存  window.onbeforeunload
        
 -->

</html>
<script>
    // 先判断是否有本地值 (转换为数组)
    let TodoList = JSON.parse(window.localStorage.getItem("todoMVC"));
    if(TodoList){
        // 存在 不做操作
    }else{
        TodoList= [
                {
                    name: "小胖起床",
                    complete: false,
                    isEdit: false
                },
                {
                    name: "小胖吃早餐",
                    complete: false,
                    isEdit: false
                },
                {
                    name: "小胖上班",
                    complete: false,
                    isEdit: false
                },
                {
                    name: "小胖吃中饭",
                    complete: false,
                    isEdit: false
                },
                {
                    name: "小胖下班",
                    complete: false,
                    isEdit: false
                }
            ]
    }
    // 注册一个全局自定义指令 `v-focus`
    Vue.directive('focus', {
        // 当被绑定的元素插入到 DOM 中时……
        inserted: function (el) {
            // 聚焦元素
            el.focus()
        }
    })
    // 创建vue对象
    let app = new Vue({
        el: ".todoapp",
        data: {
            // 定义全选的状态
            checkAll:false,
            // 高亮的值(默认全部)
            visibility:"全部",
            // 新增内容
            inputToDo: "",
            // 暂存此次的修改
            cacheEdit: "",
            TodoList
        },
        methods: {
            // 新增
            addToDo() {
                this.inputToDo = this.inputToDo.trim();
                if (this.inputToDo != "") {
                    this.TodoList.push({
                        name: this.inputToDo,
                        complete: false,
                        isEdit: false
                    })
                    this.inputToDo = "";
                }
            },
            //编辑
            editToDo(index) {
                this.TodoList[index].isEdit = !this.TodoList[index].isEdit;
                // 暂存的数据绑定为编辑前的
                this.cacheEdit = this.TodoList[index].name;
            },
            // 编辑状态下保存
            saveEdit(index) {
                // 保存数据
                this.TodoList[index].name = this.cacheEdit;
                // 移除编辑状态
                this.TodoList[index].isEdit = false;
            },
            //失去焦点
            beforeEdit(index) {
                // 移除编辑属性
                this.TodoList[index].isEdit = false;
            },
            // esc退出焦点
            cancelEdit(index){
                this.TodoList[index].isEdit = false;
            },
            // 清除所有
            clear(){
                this.TodoList = [];
            },
            // 删除单个事件
            deleteEdit(index){
                this.TodoList.splice(index,1);
            },
            // 判断是否高亮
            ligthHigh(data){
               this.visibility = data;
            },
            // 全选高亮
            checkAllToDo(){
                console.log(this.checkAll);
                for(let i =0;i<this.TodoList.length;i++){
                 this.TodoList[i].complete =this.checkAll;
                }
            },
            // 让全选跟着单选全部高亮而高亮
            checkIscheckAll(){
                this.checkAll = this.TodoList.length == this.TodoList.filter((v,i)=>{
                    if(v.complete==true) return v;
                }).length;
            }
        },
        computed:{
            doDoneNum(){
               return {
                    NoDone: this.TodoList.filter((v, i) => {
                        if (v.complete == false) {
                            return v;
                        }
                    }).length,
                    Done: this.TodoList.filter((v, i) => {
                        if (v.complete == true) {
                            return v;
                        }
                    }).length
                } 
            },
            // 高亮情况下显示的数组 visiableList
            visiableList() {
                return this.TodoList.filter((v, i) => {
                    switch (this.visibility) {
                        case "全部":
                            return v;
                            break;
                        case "完成":
                            if(v.complete==true) return v;
                            break;
                        case "未完成":
                            if(v.complete==false) return v;
                            break;
                    }
                })
            }

        }
    })
    // 当页面关闭
    window.onbeforeunload = function(){
        // 传唤为支付串储存
        window.localStorage.setItem("todoMVC",JSON.stringify(TodoList));
    }
</script>